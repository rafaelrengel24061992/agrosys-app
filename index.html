<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSys Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f0fdf4; font-family: sans-serif; margin: 0; }
        .aba-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; border: none; }
        .aba-ativa { background: #047857 !important; font-weight: bold; }
        .input-style { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; background: #fff; }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: #059669; font-weight: bold;">
            Carregando AgroSys...
        </div>
    </div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyDn0FwwFZNmd2bhJVwR8xbiPeCB1LEe6xw",
            authDomain: "agrosys-e3d99.firebaseapp.com",
            projectId: "agrosys-e3d99",
            storageBucket: "agrosys-e3d99.firebasestorage.app",
            messagingSenderId: "85637972190",
            appId: "1:85637972190:web:2f0f2a8b59105a0499824f"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        const RACAS = ["PINTOS P/ CORTE 1 DIA", "PINTOS P/ CORTE BRANCOS RECRIADOS", "PESADÃO CAIPIRA RECRIADO", "CAIPIRA NEGRO RECRIADO", "PESCOÇO PELADO MISTO RECRIADO", "CARIJO MISTO RECRIADO", "MESCLADO CAIPIRA RECRIADO", "PESCOÇO PELADO CARIJO MISTO RECRIADO", "PINTO PESCOÇO PELADO BRANCO RECRIADO", "CODORNAS FÊMEAS", "POSTURA CREME RECRIADA", "POSTURA BRANCA RECRIADA", "POSTURA NEGRA RECRIADA", "POSTURA VERMELHA RECRIADA", "POSTURA CINZA RECRIADA", "POSTURA OVOS AZUIS RECRIADA", "POSTURA VERMELHA OVOS VERDES"];

        function App() {
            const [autenticado, setAutenticado] = React.useState(sessionStorage.getItem('logado') === 'true');
            const [senhaDigitada, setSenhaDigitada] = React.useState('');
            const [aba, setAba] = React.useState('encomenda');
            const [pedidos, setPedidos] = React.useState([]);
            const [cliente, setCliente] = React.useState('');
            const [telefone, setTelefone] = React.useState('');
            const [linhas, setLinhas] = React.useState([{ raca: '', qtd: '' }]);
            
            const vendedor = localStorage.getItem('vendedor') || '';
            const telVendedor = localStorage.getItem('telVendedor') || '';
            const SENHA_MESTRA = "1234"; 

            React.useEffect(() => {
                if (!autenticado) return;
                const unsub = db.collection("encomendas").orderBy("data", "desc").onSnapshot(snap => {
                    setPedidos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [autenticado]);

            const fazerLogin = () => {
                if (senhaDigitada === SENHA_MESTRA) {
                    setAutenticado(true);
                    sessionStorage.setItem('logado', 'true');
                } else { alert("Senha incorreta!"); }
            };

            const abrirWhats = (n) => {
                const l = n ? n.replace(/\D/g, '') : '';
                if(l) window.open(`https://wa.me/55${l}`, '_blank');
            };

            const salvar = async () => {
                if(!cliente || !linhas[0].raca) return alert("Preencha Nome e Raça");
                try {
                    await db.collection("encomendas").add({
                        cliente, telefone, itens: linhas.filter(i => i.raca && i.qtd),
                        data: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setCliente(''); setTelefone(''); setLinhas([{ raca: '', qtd: '' }]);
                    alert("Salvo!");
                } catch(e) { alert("Erro ao salvar."); }
            };

            const limparTudo = async () => {
                if(confirm("CUIDADO: Isso apagará TODOS os pedidos do banco de dados para iniciar um novo carregamento. Tem certeza?")) {
                    const snap = await db.collection("encomendas").get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    alert("Banco de dados limpo!");
                }
            };

            const exportarPDF = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text("AGROPOSTAI - RESUMO DE PEDIDOS", 14, 15);
                    const consolidados = {};
                    pedidos.forEach(p => p.itens?.forEach(i => {
                        consolidados[i.raca] = (consolidados[i.raca] || 0) + Number(i.qtd);
                    }));
                    const data = Object.entries(consolidados);
                    doc.autoTable({
                        head: [['Raca', 'Qtd']],
                        body: data,
                        startY: 25,
                        headStyles: { fillColor: [5, 150, 105] }
                    });
                    doc.save("pedidos_agropostai.pdf");
                } catch (e) { alert("Erro ao gerar PDF."); }
            };

            if (!autenticado) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-emerald-900 p-6">
                        <div className="bg-white p-8 rounded-3xl w-full max-w-xs text-center shadow-2xl">
                            <h2 className="text-2xl font-black text-emerald-700 mb-4 tracking-tighter">AGROSYS</h2>
                            <input type="password" placeholder="Senha" className="input-style mb-4 text-center border-2" value={senhaDigitada} onChange={e => setSenhaDigitada(e.target.value)} onKeyPress={e => e.key === 'Enter' && fazerLogin()} />
                            <button onClick={fazerLogin} className="w-full bg-emerald-600 text-white p-4 rounded-xl font-bold active:scale-95 transition-transform">ENTRAR</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto bg-white min-h-screen shadow-lg">
                    <div className="flex bg-emerald-600 text-white sticky top-0 z-10 shadow-md">
                        <button onClick={() => setAba('encomenda')} className={`aba-btn ${aba === 'encomenda' ? 'aba-ativa' : ''}`}>ENCOMENDA</button>
                        <button onClick={() => setAba('resumo')} className={`aba-btn ${aba === 'resumo' ? 'aba-ativa' : ''}`}>RESUMO</button>
                    </div>

                    {aba === 'encomenda' ? (
                        <div className="p-5 space-y-4 animate-in fade-in duration-500">
                            <h2 className="font-bold text-emerald-800 text-sm uppercase">Novo Pedido</h2>
                            <input placeholder="Nome do Cliente" className="input-style border-emerald-100 shadow-sm" value={cliente} onChange={e => setCliente(e.target.value)} />
                            <div className="flex gap-2">
                                <input placeholder="WhatsApp" className="flex-1 input-style border-emerald-100 shadow-sm" value={telefone} onChange={e => setTelefone(e.target.value)} />
                                <button onClick={() => abrirWhats(telefone)} className="bg-green-500 text-white px-4 rounded-xl font-bold shadow-sm">ZAP</button>
                            </div>

                            <div className="pt-4 border-